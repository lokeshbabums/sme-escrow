generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String   @unique
  emailVerified DateTime?
  passwordHash  String?
  role          String   @default("CLIENT")
  mustChangePassword Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  profile       Profile?
  accounts      Account[]
  sessions      Session[]

  clientProjects     Project[] @relation("ClientProjects")
  vendorProjects Project[] @relation("VendorProjects")

  wallet             Wallet?
  payments           Payment[]
  invoices           Invoice[]
  sentMessages       Message[]
  fileAttachments    FileAttachment[]
  webhookEndpoints   WebhookEndpoint[]
  featureFlags       FeatureFlag[]
  notifications      Notification[]
  fabricUpdates      FabricUpdate[]    @relation("FabricUpdates")
  vendorAdvances     CapitalAdvance[]  @relation("VendorAdvances")
  disputesOpened     Dispute[]         @relation("DisputeOpenedBy")
  disputesDecided    Dispute[]         @relation("DisputeDecidedBy")
  activityEvents     ActivityEvent[]   @relation("ActivityEvents")
}

model Profile {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id])
  headline       String?
  bio            String?
  company        String?
  businessCategory String?  // HOTEL | HOSPITAL | HOSTEL | SALON | RESTAURANT | GENERAL
  location       String?
  kycStatus      String    @default("NOT_STARTED")
  docType        String?
  docNumber      String?
  docFileUrl     String?
  kycVerifiedAt  DateTime?
  kycVerifiedBy  String?
  kycNotes       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Project {
  id           String       @id @default(cuid())
  title        String
  description  String
  clientId     String
  vendorId String?
  status       String       @default("DRAFT")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  client       User  @relation("ClientProjects", fields: [clientId], references: [id])
  vendor   User? @relation("VendorProjects", fields: [vendorId], references: [id])

  milestones         Milestone[]
  disputes           Dispute[]
  messages           Message[]
  invoices           Invoice[]
  walletTransactions WalletTransaction[]
  orderItems         OrderItem[]
  capitalAdvances    CapitalAdvance[]
  activityEvents     ActivityEvent[]
}

model Milestone {
  id            String   @id @default(cuid())
  projectId     String
  title         String
  description   String
  amountCents   Int
  releasedCents Int      @default(0)
  dueDate       DateTime?
  status        String   @default("DRAFT")
  fundedAt      DateTime?
  submittedAt   DateTime?
  releasedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project            Project @relation(fields: [projectId], references: [id])
  escrow             EscrowLedgerEntry[]
  disputes           Dispute[]
  invoices           Invoice[]
  attachments        FileAttachment[]
  walletTransactions WalletTransaction[]
  activityEvents     ActivityEvent[]
}

model EscrowLedgerEntry {
  id          String   @id @default(cuid())
  milestoneId String
  type        String   // DEPOSIT | RELEASE | PROOF_SUBMITTED | DISPUTE_OPENED
  amountCents Int
  note        String?
  createdAt   DateTime @default(now())

  milestone   Milestone @relation(fields: [milestoneId], references: [id])
}

model Dispute {
  id          String   @id @default(cuid())
  projectId   String
  milestoneId String?
  status      String   @default("OPEN")
  reason      String
  resolution  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  claimType              String?   // DAMAGE | LOSS | DELAY | QUALITY
  openedById             String?
  compensationCents      Int       @default(0)
  compensationRecipient  String?   // CLIENT | VENDOR
  compensationNote       String?
  decidedById            String?
  decidedAt              DateTime?

  project     Project    @relation(fields: [projectId], references: [id])
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])
  attachments FileAttachment[]
  openedBy    User?      @relation("DisputeOpenedBy", fields: [openedById], references: [id])
  decidedBy   User?      @relation("DisputeDecidedBy", fields: [decidedById], references: [id])
  activityEvents ActivityEvent[]
}

model Wallet {
  id             String   @id @default(cuid())
  userId         String   @unique
  currency       String   @default("INR")
  availableCents Int      @default(0)
  heldCents      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
  transactions   WalletTransaction[]
  payments       Payment[]
}

model WalletTransaction {
  id            String     @id @default(cuid())
  walletId      String
  type          String     // DEPOSIT | WITHDRAWAL | HOLD | RELEASE | REFUND
  amountCents   Int
  status        String     @default("POSTED")
  projectId     String?
  milestoneId   String?
  note          String?
  createdAt     DateTime   @default(now())
  wallet        Wallet     @relation(fields: [walletId], references: [id])
  project       Project?   @relation(fields: [projectId], references: [id])
  milestone     Milestone? @relation(fields: [milestoneId], references: [id])
}

model Payment {
  id              String    @id @default(cuid())
  userId          String
  walletId        String
  gateway         String    // RAZORPAY | STRIPE | UPI_DIRECT | DEMO
  gatewayOrderId  String?   // razorpay order_id or stripe payment_intent id
  gatewayPaymentId String?  // razorpay payment_id or stripe charge id
  method          String?   // upi | card | netbanking | wallet
  amountCents     Int
  currency        String    @default("INR")
  status          String    @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED | REFUNDED
  failureReason   String?
  metadataJson    String?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])
  wallet          Wallet    @relation(fields: [walletId], references: [id])
}

model Invoice {
  id            String     @id @default(cuid())
  number        String     @unique
  type          String     // DEPOSIT | RELEASE | PARTIAL_RELEASE | REFUND
  status        String     @default("ISSUED")
  currency      String     @default("INR")
  subtotalCents Int
  feeCents      Int        @default(0)
  totalCents    Int
  userId        String
  projectId     String?
  milestoneId   String?
  dataJson      String
  issuedAt      DateTime   @default(now())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  user          User       @relation(fields: [userId], references: [id])
  project       Project?   @relation(fields: [projectId], references: [id])
  milestone     Milestone? @relation(fields: [milestoneId], references: [id])
}

model Message {
  id         String   @id @default(cuid())
  projectId  String
  senderId   String
  body       String
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id])
  sender     User     @relation(fields: [senderId], references: [id])
  attachments FileAttachment[]
}

model FileAttachment {
  id           String     @id @default(cuid())
  uploaderId   String
  fileName     String
  mimeType     String?
  sizeBytes    Int?
  url          String?
  milestoneId  String?
  disputeId    String?
  messageId    String?
  createdAt    DateTime   @default(now())
  uploader     User       @relation(fields: [uploaderId], references: [id])
  milestone    Milestone? @relation(fields: [milestoneId], references: [id])
  dispute      Dispute?   @relation(fields: [disputeId], references: [id])
  message      Message?   @relation(fields: [messageId], references: [id])
}

model WebhookEndpoint {
  id         String   @id @default(cuid())
  userId     String
  url        String
  secret     String?
  enabled    Boolean  @default(true)
  eventTypes String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  events     WebhookEvent[]
}

model WebhookEvent {
  id             String    @id @default(cuid())
  endpointId     String
  eventType      String
  payloadJson    String
  status         String    @default("PENDING")
  attempts       Int       @default(0)
  lastAttemptAt  DateTime?
  deliveredAt    DateTime?
  responseStatus Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  endpoint       WebhookEndpoint @relation(fields: [endpointId], references: [id])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  userId      String
  key         String   // KYC_REQUIRED | WALLET_ENABLED | WEBHOOKS_ENABLED | MESSAGING_ENABLED | PARTIAL_RELEASE | FILE_UPLOADS
  enabled     Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  @@unique([userId, key])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  read      Boolean  @default(false)
  linkUrl   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model OrderItem {
  id             String    @id @default(cuid())
  projectId      String
  category       String    // LINEN | PILLOW_COVER | TOWEL | BEDSHEET | CURTAIN | UNIFORM | NAPKIN | TABLECLOTH | BLANKET | OTHER
  itemName       String
  quantity       Int
  notes          String?
  currentStage   String    @default("RECEIVED") // RECEIVED | SORTING | WASHING | DRYING | PRESSING | QC_CHECK | PACKED | DELIVERED
  currentStageAt DateTime?
  createdAt      DateTime  @default(now())
  project        Project   @relation(fields: [projectId], references: [id])
  fabricUpdates  FabricUpdate[]
  activityEvents ActivityEvent[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id])
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model FabricUpdate {
  id          String   @id @default(cuid())
  orderItemId String
  stage       String   // RECEIVED | SORTING | WASHING | DRYING | PRESSING | QC_CHECK | PACKED | DELIVERED
  note        String?
  actorId     String
  createdAt   DateTime @default(now())

  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  actor       User      @relation("FabricUpdates", fields: [actorId], references: [id])
}

model CapitalAdvance {
  id             String   @id @default(cuid())
  projectId      String
  vendorId       String
  requestedCents Int
  approvedCents  Int      @default(0)
  status         String   @default("REQUESTED") // REQUESTED | APPROVED | REJECTED | CANCELLED
  repaidCents    Int      @default(0)
  repaidAt       DateTime?
  decisionNote   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project        Project  @relation(fields: [projectId], references: [id])
  vendor         User     @relation("VendorAdvances", fields: [vendorId], references: [id])
  activityEvents ActivityEvent[]
}

model ActivityEvent {
  id               String   @id @default(cuid())
  type             String   // FABRIC_UPDATE | ADVANCE_REQUESTED | ADVANCE_APPROVED | ADVANCE_REJECTED | CLAIM_OPENED | CLAIM_DECIDED | MILESTONE_FUNDED | MILESTONE_SUBMITTED | MILESTONE_RELEASED | DISPUTE_OPENED | PAYMENT_COMPLETED
  createdAt        DateTime @default(now())
  actorId          String?
  projectId        String?
  milestoneId      String?
  orderItemId      String?
  disputeId        String?
  capitalAdvanceId String?
  summary          String?
  metadataJson     String?

  actor            User?           @relation("ActivityEvents", fields: [actorId], references: [id])
  project          Project?        @relation(fields: [projectId], references: [id])
  milestone        Milestone?      @relation(fields: [milestoneId], references: [id])
  orderItem        OrderItem?      @relation(fields: [orderItemId], references: [id])
  dispute          Dispute?        @relation(fields: [disputeId], references: [id])
  capitalAdvance   CapitalAdvance? @relation(fields: [capitalAdvanceId], references: [id])
}
